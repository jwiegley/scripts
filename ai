#!/usr/bin/env bash

# Strict error handling
set -euo pipefail

# Fix bundled ripgrep on Asahi Linux (16KB pages break jemalloc)
fix_ripgrep_for_asahi() {
    # Only needed on aarch64 with 16KB pages
    [[ "$(uname -m)" == "aarch64" ]] || return 0
    [[ "$(getconf PAGESIZE)" == "16384" ]] || return 0

    # Find the npx cache directory for claude-code
    local npx_cache="$HOME/.npm/_npx"
    [[ -d "$npx_cache" ]] || return 0

    # Find and fix any broken ripgrep binaries
    local rg_path
    for rg_path in "$npx_cache"/*/node_modules/@anthropic-ai/claude-code/vendor/ripgrep/arm64-linux/rg; do
        [[ -e "$rg_path" ]] || continue

        # Skip if already a symlink to system rg
        [[ -L "$rg_path" ]] && continue

        # Test if the bundled rg works
        if ! "$rg_path" --version &>/dev/null; then
            # Replace with system ripgrep
            if command -v rg &>/dev/null; then
                mv "$rg_path" "${rg_path}.broken" 2>/dev/null || true
                ln -sf "$(command -v rg)" "$rg_path"
            fi
        fi
    done
}

# Default configuration
if [[ -d $HOME/.config/claude/personal ]]; then
    export CLAUDE_CONFIG_DIR=$HOME/.config/claude/personal
fi

readonly WORK_DIR="/etc/nixos"

claude_cmd="claude"
claude_args="--dangerously-skip-permissions"
droid_cmd="droid"
cmd="$claude_cmd $claude_args"
enable_mitm=false
enable_control=false

change_dir=true
if [[ $(pwd) =~ /etc/srp ]]; then
    change_dir=false
fi

if [[ $PWD =~ /pos(itron)?/ ]]; then
    if [[ -d $HOME/.config/claude/positron ]]; then
        export CLAUDE_CONFIG_DIR=$HOME/.config/claude/positron
    fi
elif [[ $PWD =~ /home/jwiegley/tron/ ]]; then
    cmd="npx @anthropic-ai/claude-code $claude_args"
fi

# Usage information
usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [ARGS...]

Options:
    --claude        Use Claude Code
    --droid         Use Factory Droid
    --sandbox       Use sandbox command instead of direct
    --mitm          Enable MITM proxy on localhost:9999
    --control       Enable browser control extension
    --here          Stay in current directory (don't cd to $WORK_DIR)
    --help, -h      Show this help message

Arguments:
    All remaining arguments are passed to the underlying command

Examples:
    $(basename "$0") --mitm
    $(basename "$0") sandbox --control
    $(basename "$0") --help

EOF
    exit 0
}

# Error handler
error() {
    echo "Error: $1" >&2
    exit 1
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --droid)
            cmd="$droid_cmd"
            shift
            ;;
        --sandbox)
            cmd="claude-sandbox $claude_args"
            shift
            ;;
        --nix)
            cmd="nix develop --command $cmd"
            shift
            ;;
        --npx)
            cmd="npx @anthropic-ai/claude-code $claude_args"
            shift
        --work|--positron)
            export CLAUDE_CONFIG_DIR=$HOME/.config/claude/positron
            shift
            ;;
        --personal)
            export CLAUDE_CONFIG_DIR=$HOME/.config/claude/personal
            shift
            ;;
        --litellm)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan
            cmd="$cmd --model hera/gpt-oss-120b"
            shift
            ;;
        --litellm-kimi)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan
            cmd="$cmd --model hera/Kimi-K2.5"
            shift
            ;;
        --local)
            export ANTHROPIC_AUTH_TOKEN=ollama
            export ANTHROPIC_BASE_URL=http://localhost:11434
            cmd="$cmd --model devstral-small-2:latest"
            shift
            ;;
        --local-tiny)
            export ANTHROPIC_AUTH_TOKEN=ollama
            export ANTHROPIC_BASE_URL=http://localhost:11434
            cmd="$cmd --model gpt-oss:20b"
            shift
            ;;
        --mitm)
            enable_mitm=true
            shift
            ;;
        --control)
            enable_control=true
            shift
            ;;
        --here)
            change_dir=false
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            # Stop processing and pass remaining args
            break
            ;;
    esac
done

# Change to working directory with error checking
if [[ "$change_dir" == true ]] \
       && [[ -d "$WORK_DIR" ]] \
       && ! cd "$WORK_DIR" 2>/dev/null; then
    error "Failed to change directory to $WORK_DIR"
fi

# Configure MITM proxy if requested
if [[ "$enable_mitm" == true ]]; then
    export NODE_TLS_REJECT_UNAUTHORIZED=0
    export HTTP_PROXY=http://localhost:9999
    export HTTPS_PROXY=http://localhost:9999
fi

# Configure browser control if requested
if [[ "$enable_control" == true ]]; then
    if ! command -v pass >/dev/null 2>&1; then
        error "pass command not found. Required for --control option."
    fi

    if ! EXTENSION_SECRET=$(pass browser-control.mcp 2>/dev/null | head -1); then
        error "Failed to retrieve extension secret from pass"
    fi
    export EXTENSION_SECRET
fi

# Fix ripgrep on Asahi Linux before launching
fix_ripgrep_for_asahi

# Execute the command with all remaining arguments
exec $cmd "$@"
