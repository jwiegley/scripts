#!/usr/bin/env bash

# Strict error handling
set -euo pipefail

# Fix bundled ripgrep on Asahi Linux (16KB pages break jemalloc)
fix_ripgrep_for_asahi() {
    # Only needed on aarch64 with 16KB pages
    [[ "$(uname -m)" == "aarch64" ]] || return 0
    [[ "$(getconf PAGESIZE)" == "16384" ]] || return 0

    # Find the npx cache directory for claude-code
    local npx_cache="$HOME/.npm/_npx"
    [[ -d "$npx_cache" ]] || return 0

    # Find and fix any broken ripgrep binaries
    local rg_path
    for rg_path in "$npx_cache"/*/node_modules/@anthropic-ai/claude-code/vendor/ripgrep/arm64-linux/rg; do
        [[ -e "$rg_path" ]] || continue

        # Skip if already a symlink to system rg
        [[ -L "$rg_path" ]] && continue

        # Test if the bundled rg works
        if ! "$rg_path" --version &>/dev/null; then
            # Replace with system ripgrep
            if command -v rg &>/dev/null; then
                mv "$rg_path" "${rg_path}.broken" 2>/dev/null || true
                ln -sf "$(command -v rg)" "$rg_path"
            fi
        fi
    done
}

# Default configuration
if [[ -d $HOME/.config/claude/personal ]]; then
    export CLAUDE_CONFIG_DIR=$HOME/.config/claude/personal
fi

readonly WORK_DIR="/etc/nixos"

claude_cmd="claude"
claude_args="--dangerously-skip-permissions"
droid_cmd="droid"
cmd="$claude_cmd $claude_args"
enable_mitm=false
enable_control=false
enable_checks=true

change_dir=true
if [[ $(pwd) =~ /etc/srp ]]; then
    change_dir=false
fi

if [[ $PWD =~ /pos(itron)?/ ]]; then
    if [[ -d $HOME/.config/claude/positron ]]; then
        export CLAUDE_CONFIG_DIR=$HOME/.config/claude/positron
    fi
elif [[ $PWD =~ /tron/ ]]; then
    if [[ -d $HOME/.config/claude/positron ]]; then
        export CLAUDE_CONFIG_DIR=$HOME/.config/claude/positron
    fi
elif [[ $PWD =~ /home/jwiegley/ ]]; then
    cmd="npx @anthropic-ai/claude-code $claude_args"
fi

# Usage information
usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [ARGS...]

Options:
    --claude        Use Claude Code
    --droid         Use Factory Droid
    --sandbox       Use sandbox command instead of direct
    --mitm          Enable MITM proxy on localhost:9999
    --control       Enable browser control extension
    --here          Stay in current directory (don't cd to $WORK_DIR)
    --no-check      Skip preflight tool checks
    --help, -h      Show this help message

Arguments:
    All remaining arguments are passed to the underlying command

Examples:
    $(basename "$0") --mitm
    $(basename "$0") sandbox --control
    $(basename "$0") --help

EOF
    exit 0
}

# Error handler
error() {
    echo "Error: $1" >&2
    exit 1
}

# Preflight checks for Claude Code session tools
preflight_checks() {
    local config_dir="${CLAUDE_CONFIG_DIR:-$HOME/.config/claude}"
    local results=()
    local warnings=()

    # GSD (Get Shit Done)
    local gsd_dir="$config_dir/get-shit-done"
    if [[ -f "$gsd_dir/VERSION" ]]; then
        results+=("GSD $(<"$gsd_dir/VERSION")")
    elif [[ -d "$gsd_dir" ]]; then
        results+=("GSD")
    else
        warnings+=("GSD not found in $config_dir")
    fi

    # Beads
    if command -v bd &>/dev/null; then
        local bd_ver
        bd_ver=$(bd --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1) || true
        if bd ready &>/dev/null; then
            results+=("Beads ${bd_ver:-?}")
        else
            results+=("Beads ${bd_ver:-?} (not initialized here)")
        fi
    else
        warnings+=("Beads: 'bd' not found")
    fi

    # Claude-mem
    local mem_dirs=("$config_dir"/plugins/cache/thedotmack/claude-mem/*)
    if [[ -d "${mem_dirs[0]:-}" ]]; then
        local mem_ver
        mem_ver=$(basename "${mem_dirs[-1]}")
        results+=("Claude-mem $mem_ver")
    else
        warnings+=("Claude-mem plugin not found")
    fi

    # Cozempic
    if command -v cozempic &>/dev/null; then
        local coz_ver
        coz_ver=$(cozempic --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1) || true
        results+=("Cozempic ${coz_ver:-?}")
    else
        warnings+=("Cozempic not found")
    fi

    # git-ai
    if command -v git-ai &>/dev/null; then
        local gitai_ver
        gitai_ver=$(git-ai --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1) || true
        local git_chain
        git_chain=$(whither git 2>/dev/null) || true
        if [[ "$git_chain" == *git-ai* ]]; then
            results+=("git-ai ${gitai_ver:-?} (wrapping git)")
        else
            results+=("git-ai ${gitai_ver:-?}")
            warnings+=("git is not wrapped by git-ai")
        fi
    else
        warnings+=("git-ai not found")
    fi

    # Output
    echo "Preflight:"
    for r in "${results[@]}"; do
        echo "  ✓ $r"
    done
    for w in "${warnings[@]}"; do
        echo "  ✗ $w"
    done
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --droid)
            cmd="$droid_cmd"
            shift
            ;;
        --sandbox)
            cmd="claude-sandbox $claude_args"
            shift
            ;;
        --nix)
            cmd="nix develop --command $cmd"
            shift
            ;;
        --npx)
            cmd="npx @anthropic-ai/claude-code $claude_args"
            shift
            ;;
        --work|--positron)
            export CLAUDE_CONFIG_DIR=$HOME/.config/claude/positron
            shift
            ;;
        --personal)
            export CLAUDE_CONFIG_DIR=$HOME/.config/claude/personal
            shift
            ;;
        --litellm-opus)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan/anthropic
            cmd="$cmd --model claude-opus-4-6"
            shift
            ;;
        --litellm-vibe-opus)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan
            cmd="$cmd --model hera/claude-opus-4-6-thinking-32000"
            shift
            ;;
        --litellm-gpt-oss)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan
            cmd="$cmd --model hera/gpt-oss-120b"
            shift
            ;;
        --litellm-kimi)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan
            cmd="$cmd --model hera/Kimi-K2.5"
            shift
            ;;
        --litellm-minimax)
            export ANTHROPIC_AUTH_TOKEN=$(pass litellm.vulcan.lan | head -1)
            export ANTHROPIC_BASE_URL=https://litellm.vulcan.lan
            export ANTHROPIC_MODEL=hera/mlx-community/MiniMax-M2.5-8bit
            export CLAUDE_CODE_SUBAGENT_MODEL=hera/mlx-community/MiniMax-M2.5-8bit
            export ANTHROPIC_DEFAULT_OPUS_MODEL=hera/mlx-community/MiniMax-M2.5-8bit
            export ANTHROPIC_DEFAULT_SONNET_MODEL=hera/mlx-community/MiniMax-M2.5-8bit
            export ANTHROPIC_DEFAULT_HAIKU_MODEL=hera/mlx-community/MiniMax-M2.5-8bit
            cmd="$cmd --model hera/mlx-community/MiniMax-M2.5-8bit"
            shift
            ;;
        --ollama-devstral)
            export ANTHROPIC_AUTH_TOKEN=ollama
            export ANTHROPIC_BASE_URL=http://localhost:11434
            cmd="$cmd --model devstral-small-2:latest"
            shift
            ;;
        --ollama-qwen-coder)
            export ANTHROPIC_AUTH_TOKEN=llama-swap
            export ANTHROPIC_BASE_URL=http://localhost:8080
            cmd="$cmd --model Qwen3-Coder-Next"
            shift
            ;;
        --ollama-gpt-oss)
            export ANTHROPIC_AUTH_TOKEN=ollama
            export ANTHROPIC_BASE_URL=http://localhost:11434
            cmd="$cmd --model gpt-oss:20b"
            shift
            ;;
        --mitm)
            enable_mitm=true
            shift
            ;;
        --control)
            enable_control=true
            shift
            ;;
        --here)
            change_dir=false
            shift
            ;;
        --no-check)
            enable_checks=false
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            # Stop processing and pass remaining args
            break
            ;;
    esac
done

# Change to working directory with error checking
if [[ "$change_dir" == true ]] \
       && [[ -d "$WORK_DIR" ]] \
       && ! cd "$WORK_DIR" 2>/dev/null; then
    error "Failed to change directory to $WORK_DIR"
fi

# Configure MITM proxy if requested
if [[ "$enable_mitm" == true ]]; then
    export NODE_TLS_REJECT_UNAUTHORIZED=0
    export HTTP_PROXY=http://localhost:9999
    export HTTPS_PROXY=http://localhost:9999
fi

# Configure browser control if requested
if [[ "$enable_control" == true ]]; then
    if ! command -v pass >/dev/null 2>&1; then
        error "pass command not found. Required for --control option."
    fi

    if ! EXTENSION_SECRET=$(pass browser-control.mcp 2>/dev/null | head -1); then
        error "Failed to retrieve extension secret from pass"
    fi
    export EXTENSION_SECRET
fi

# Fix ripgrep on Asahi Linux before launching
fix_ripgrep_for_asahi

# Run preflight checks
if [[ "$enable_checks" == true ]]; then
    preflight_checks
fi

# Execute the command with all remaining arguments
exec $cmd "$@"
